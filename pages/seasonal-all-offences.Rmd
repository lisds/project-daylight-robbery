# All offences 

```{python}
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
from projtools.data import Data
from projtools import stats

data = Data()
idx = pd.IndexSlice
```

```{python}
summer_months = ["04","05","06","07","08","09","10"]
winter_months = ["01","02","03","11","12"]
```

```{python}
summer = (data.borough
              .loc[:, idx["2011":"2022", summer_months]])
winter = (data.borough
              .loc[:, idx["2011":"2022", winter_months]])
```

```{python}
offences = (data.borough
                .index
                .get_level_values("offence")
                .unique())

diff_dict = pd.Series()

for index, offence in enumerate(offences):
    summer_month_offences = (summer.loc[idx[:,offence], :]
                                   .sum()
                                   .T
                                   .groupby(level="month")
                                   .sum()
                                   .sort_values(ascending=False))
    
    winter_month_offences = (winter.loc[idx[:,offence], :]
                                   .sum()
                                   .T
                                   .groupby(level="month")
                                   .sum()
                                   .sort_values(ascending=False))
    
    summer_mean = summer_month_offences.sum() / len(summer_months)
    winter_mean = winter_month_offences.sum() / len(winter_months)
    
    diff_dict[offence] = summer_mean - winter_mean

```

- Burglary - enter property (not a property you should be in) and take something
- Robbery - take something by force (use of weapon or threat of harm)
- Theft - taking something e.g. from a shop, pickpocketing

----

- negative value = higher in winter
- positive value = higher in summer

```{python}
diff_dict.sort_values()
```

```{python}
decent_diff = abs(diff_dict).sort_values(ascending=False) > 200
defcent_diffs = diff_dict.loc[decent_diff]
```

```{python}
results = {"offence": [], "actual_diff": [], "p_value": []}

for index, value in enumerate(defcent_diffs):
    
    offence = defcent_diffs.keys()[index]
    
    summer_crime = (summer.loc[idx[:,offence], :]
                          .sum()
                          .T
                          .groupby(level="month")
                          .sum())
    
    winter_crime = (winter.loc[idx[:,offence], :]
                          .sum()
                          .T
                          .groupby(level="month")
                          .sum())

    if value > 0:
        actual_diff, fake_diffs, p_value = stats.permutation_test(summer_crime, winter_crime, alternative="less")

        results["offence"].append(offence)
        results["actual_diff"].append(actual_diff)
        results["p_value"].append(p_value)
    elif value < 0:
        actual_diff, fake_diffs, p_value = stats.permutation_test(summer_crime, winter_crime, alternative="greater")
    
        results["offence"].append(offence)
        results["actual_diff"].append(actual_diff)
        results["p_value"].append(p_value)
    
pd.DataFrame(results).sort_values(by="p_value")
```

# A better permutation test

```{python}
summer_crime = (summer.loc[idx[:,"Wildlife Crime"], :]
                          .sum()
                          .T
                          .groupby(level="month")
                          .sum())

winter_crime = (winter.loc[idx[:,"Wildlife Crime"], :]
                          .sum()
                          .T
                          .groupby(level="month")
                          .sum())

crime = np.sum(summer_crime) + np.sum(winter_crime)
```

```{python}
months = ["01","02","03","04","05","06","07","08","09","10","11","12"]
```

```{python}
def better_permutation_test(group1,
                     group2,
                     alternative='greater',
                     n_iters=10_000) -> (float, np.array, float):
    
    actual_diff = np.mean(group1) - np.mean(group2)

    n_subjects = len(group1)
    fake_diffs = np.zeros(n_iters)
    total = int(np.sum(group1) + np.sum(group2))
    months = ["01","02","03","04","05","06","07","08","09","10","11","12"]
    
    for index in range(n_iters):
        shuffled_observations = np.random.choice(months, total)
        shuffled_obs_dict = {"01": [],"02": [],"03": [],"04": [],"05": [],"06": [],"07": [],"08": [],"09": [],"10": [],"11": [],"12": []}
        for index2, key in enumerate(shuffled_obs_dict):
            shuffled_obs_dict[key] = np.count_nonzero(shuffled_observations == key)

        shuffled_obs_group1_mean = np.mean(pd.Series(shuffled_obs_dict).iloc[:n_subjects])
        shuffled_obs_group2_mean = np.mean(pd.Series(shuffled_obs_dict).iloc[n_subjects:])
        
        fake_diffs[index] = shuffled_obs_group1_mean - shuffled_obs_group2_mean
    
    n_alt = 0
    if alternative == 'greater':
        n_alt = np.count_nonzero(fake_diffs <= actual_diff)
    elif alternative == 'less':
        n_alt = np.count_nonzero(fake_diffs >= actual_diff)

    return actual_diff, fake_diffs, n_alt / n_iters
```

```{python}
better_permutation_test(summer_crime, winter_crime, alternative="less")
```

```{python}
fake_observations = np.random.choice(months, int(crime))
fake_obs_dict = {"01": [],"02": [],"03": [],"04": [],"05": [],"06": [],"07": [],"08": [],"09": [],"10": [],"11": [],"12": []}
for index, key in enumerate(fake_obs_dict):
    fake_obs_dict[key] = np.count_nonzero(fake_observations == key)
    
fake_obs_winter = pd.Series(fake_obs_dict).loc[winter_months]
fake_obs_summer = pd.Series(fake_obs_dict).loc[summer_months]
fake_obs_winter
```
